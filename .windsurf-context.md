# 🎯 WINDSURF CONTEXT & GUIDANCE

**Generated:** 2025-10-14T19:08:12.672Z
**Intent:** add document storage feature

---

## 📐 Architecture & Structure

**Current Setup:** Next.js 13+ App Router

### Conventions You MUST Follow:

- Routes in /app directory
- API routes in /app/api
- Server components by default
- Client components marked with "use client"
- Layout hierarchy for shared UI
- 
Domain Organization in lib/:
-   - lib/__tests__/ (domain logic)
-   - lib/ai/ (domain logic)
-   - lib/auth/ (domain logic)
-   - lib/cache/ (domain logic)
-   - lib/clients/ (domain logic)
-   - lib/config/ (domain logic)
-   - lib/dashboard/ (domain logic)
-   - lib/design-system/ (domain logic)
-   - lib/domain/ (domain logic)
-   - lib/geocoding/ (domain logic)

### Anti-Patterns to AVOID:

- ❌ Creating pages in /pages when using App Router
- ❌ Mixing App Router and Pages Router
- ❌ Client components without "use client"
- ❌ Deeply nested route structures

### Best Practices:

- ✅ Colocate route components with their routes
- ✅ Use route groups (folder) for organization
- ✅ Extract shared logic to /lib
- ✅ Keep reusable components in /components
- ✅ New features should follow existing domain structure
- ✅ Keep business logic in lib/, not in components or routes
- ✅ One domain = one folder in lib/

## 📦 Import Strategy (CRITICAL!)

### 🚨 WARNING: Deep Import Nesting Detected!

This codebase has imports nested up to **4 levels deep**.

**DO NOT add more deeply nested imports!** Use path aliases instead.

#### Examples of problematic imports in this codebase:

- `windsurf-context.ts`: 4 levels: ../../../../lib/vehicles/api"\n
- `windsurf-context.ts`: 3 levels: ../../../components/vehicles/VehicleCard"\n

**You must NOT repeat these patterns!**

### Rules You MUST Follow:

- ALWAYS use @/ for absolute imports
- NEVER nest more than 2 levels (../../ max)
- Prefer @/lib/domain/module over relative paths
- Keep imports flat and discoverable
- Use consistent import order: external → @/ → relative

### Examples:

```typescript
// ✅ CORRECT - Use path alias
import { VehicleService } from "@/lib/vehicles/api"
import { VehicleCard } from "@/components/vehicles/VehicleCard"
import { withTenantIsolation } from "@/lib/middleware/tenant-isolation"

// ❌ WRONG - Deep relative imports
import { VehicleService } from "../../../../lib/vehicles/api"
import { VehicleCard } from "../../../components/vehicles/VehicleCard"
```

## ✅ Validation Rules

### REQUIRED (CI will fail if missing):

- ✅ Every new feature MUST have tests
- ✅ Every API route MUST use withTenantIsolation middleware
- ✅ Every database table MUST have tenant_id column
- ✅ Every migration MUST have a rollback script
- ✅ Every component MUST use TypeScript (not JavaScript)

### FORBIDDEN (CI will fail if present):

- ❌ NO auth.uid() in RLS policies (use app.current_tenant_id)
- ❌ NO localStorage in server components
- ❌ NO hardcoded tenant IDs anywhere
- ❌ NO mock users in production code
- ❌ NO deeply nested imports (>2 levels of ../)
- ❌ NO unprotected API routes

### RECOMMENDED:

- 💡 Use path aliases (@/) for all imports
- 💡 Extract common logic to lib/ directory
- 💡 Follow existing domain structure
- 💡 Add JSDoc comments for public APIs
- 💡 Use meaningful, descriptive variable names
- 💡 Keep files under 300 lines when possible

## 📚 Examples from This Codebase

**Study these existing features before creating new code:**

### auth

**Why this is a good example:** Good structure

**Structure:**
- Business Logic: 4 files
- Routes: 3 files
- Components: 1 files
- Tests: 0 files

**Key files to study:**
- `lib/auth/types.ts`
- `lib/auth/server.ts`
- `lib/auth/config.ts`
- `lib/auth/client.ts`
- `components/auth/SupabaseAuthProvider.tsx`
- `app/auth/signin/page.tsx`
- `app/auth/error/page.tsx`
- `app/auth/callback/route.ts`

### clients

**Why this is a good example:** Good structure

**Structure:**
- Business Logic: 6 files
- Routes: 0 files
- Components: 0 files
- Tests: 0 files

**Key files to study:**
- `lib/clients/supabase.ts`
- `lib/clients/supabase-browser.ts`
- `lib/clients/supabase-admin.ts`
- `lib/clients/samsara-client.ts`
- `lib/clients/llm-client.ts`
- `lib/clients/api-usage-tracker.ts`

## 🏗️ Recommended Structure for Your Task

Based on the analysis above, here's the recommended structure:

```
lib/document/
  ├── types.ts           # TypeScript types
  ├── api.ts             # API client functions
  ├── validation.ts      # Validation schemas
  └── utils.ts           # Helper functions

app/document/
  └── page.tsx           # Route page

components/document/
  ├── List.tsx           # List component
  └── Form.tsx           # Form component

tests/document/
  ├── api.test.ts        # Unit tests
  └── integration.test.ts # Integration tests
```

## 📋 Pre-Flight Checklist

Before generating ANY code, verify you have:

- [ ] Read and understood the architecture
- [ ] Reviewed the import strategy rules
- [ ] Studied at least one example feature
- [ ] Planned the file structure
- [ ] Confirmed you will use @/ imports
- [ ] Confirmed you will add tests
- [ ] Confirmed you understand validation rules

## 🚀 Recommended Workflow

1. **Study Examples** - Look at similar features first
2. **Plan Structure** - Match existing patterns exactly
3. **Use Path Aliases** - Never use deeply nested imports
4. **Generate Code** - Follow all rules above
5. **Add Tests** - Required for all features
6. **Validate** - Run checks before committing

### Validation Commands:

```bash
# Check if code fits patterns
npm run repo:analyze

# Clean up any issues
npm run repo:clean

# Validate database (if applicable)
npm run db:validate

# Run security tests
npm run test:security

# Run all tests
npm test
```

---

**Remember:**
- This guidance was generated by analyzing YOUR codebase
- Following these rules ensures your code fits perfectly
- When in doubt, copy the structure of existing features
- Use @/ imports, always!

*Generated by Windsurf Context Engine*
