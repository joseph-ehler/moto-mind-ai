# Windsurf Workflow: Safe Database Migration
# Triggers: Manual
# Purpose: Test and apply database migrations safely

name: Safe Database Migration
description: Tests migration in sandbox, then applies with safety checks

on:
  manual: true

inputs:
  migration_file:
    description: Path to migration file (e.g., supabase/migrations/20251014_add_table.sql)
    required: true

env:
  MIGRATION_FILE: ${{ inputs.migration_file }}

steps:
  - name: Validate Migration File Exists
    run: |
      if [ ! -f "${MIGRATION_FILE}" ]; then
        echo "❌ ERROR: Migration file not found: ${MIGRATION_FILE}"
        exit 1
      fi
      echo "✅ Migration file found: ${MIGRATION_FILE}"
    
  - name: Test Migration in Sandbox
    run: |
      echo ""
      echo "🧪 Testing migration in isolated sandbox..."
      npm run db:test-migration "${MIGRATION_FILE}"
      echo ""
    continue_on_error: false

  - name: Review Impact
    run: |
      echo "⚠️  REVIEW THE IMPACT ANALYSIS ABOVE"
      echo ""
      echo "The migration will:"
      echo "  • Modify tables/columns/indexes/policies as shown"
      echo "  • Changes are REVERSIBLE via rollback"
      echo ""
      echo "Proceeding with migration..."
      sleep 2

  - name: Apply Migration with Safety Checks
    run: |
      echo ""
      echo "🚀 Applying migration with safety checks..."
      npm run db:smart-migrate
      echo ""
    continue_on_error: false

  - name: Validate Database Health
    run: |
      echo ""
      echo "🔍 Validating database health..."
      npm run db:validate
      echo ""
    continue_on_error: false

  - name: Success Message
    run: |
      echo ""
      echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      echo "✅ Migration completed successfully!"
      echo ""
      echo "What happened:"
      echo "  ✅ Tested in sandbox (no damage possible)"
      echo "  ✅ Applied with safety checks"
      echo "  ✅ Database validated and healthy"
      echo ""
      echo "Your database is ready! 🎉"
      echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
