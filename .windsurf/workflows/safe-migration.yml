# Windsurf Workflow: Safe Database Migration
# Triggers: Manual
# Purpose: Test and apply database migrations safely

name: Safe Database Migration
description: Tests migration in sandbox, then applies with safety checks

on:
  manual: true

inputs:
  migration_file:
    description: Path to migration file (e.g., supabase/migrations/20251014_add_table.sql)
    required: true

env:
  MIGRATION_FILE: ${{ inputs.migration_file }}

steps:
  - name: Validate Migration File Exists
    run: |
      if [ ! -f "${MIGRATION_FILE}" ]; then
        echo "âŒ ERROR: Migration file not found: ${MIGRATION_FILE}"
        exit 1
      fi
      echo "âœ… Migration file found: ${MIGRATION_FILE}"
    
  - name: Test Migration in Sandbox
    run: |
      echo ""
      echo "ğŸ§ª Testing migration in isolated sandbox..."
      npm run db:test-migration "${MIGRATION_FILE}"
      echo ""
    continue_on_error: false

  - name: Review Impact
    run: |
      echo "âš ï¸  REVIEW THE IMPACT ANALYSIS ABOVE"
      echo ""
      echo "The migration will:"
      echo "  â€¢ Modify tables/columns/indexes/policies as shown"
      echo "  â€¢ Changes are REVERSIBLE via rollback"
      echo ""
      echo "Proceeding with migration..."
      sleep 2

  - name: Apply Migration with Safety Checks
    run: |
      echo ""
      echo "ğŸš€ Applying migration with safety checks..."
      npm run db:smart-migrate
      echo ""
    continue_on_error: false

  - name: Validate Database Health
    run: |
      echo ""
      echo "ğŸ” Validating database health..."
      npm run db:validate
      echo ""
    continue_on_error: false

  - name: Success Message
    run: |
      echo ""
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "âœ… Migration completed successfully!"
      echo ""
      echo "What happened:"
      echo "  âœ… Tested in sandbox (no damage possible)"
      echo "  âœ… Applied with safety checks"
      echo "  âœ… Database validated and healthy"
      echo ""
      echo "Your database is ready! ğŸ‰"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
