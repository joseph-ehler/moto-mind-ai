# Windsurf Workflow: Pre-Commit Check
# Triggers: Before git commit
# Purpose: Catch all issues before code is committed

name: Pre-Commit Check
description: Comprehensive validation before committing code

on:
  manual: true
  # Future: before_git_commit event when available

steps:
  - name: Start Message
    run: |
      echo "ğŸ” Running pre-commit validation..."
      echo ""

  - name: Check Import Patterns
    run: |
      echo "ğŸ“¦ Checking imports..."
      DEEP_IMPORTS=$(grep -r "from ['\"]\.\.\/\.\.\/\.\.\/" \
        --include="*.ts" \
        --include="*.tsx" \
        --exclude-dir="node_modules" \
        --exclude-dir=".next" \
        app/ lib/ components/ 2>/dev/null | wc -l | xargs)
      
      if [ "$DEEP_IMPORTS" -gt 0 ]; then
        echo "âš ï¸  WARNING: Found $DEEP_IMPORTS files with deep imports (../../../)"
        echo "   Consider fixing with: npm run repo:clean --fix"
      else
        echo "âœ… No deep imports found"
      fi
      echo ""

  - name: Repository Analysis
    run: |
      echo "ğŸ“Š Analyzing repository..."
      npm run repo:analyze
      echo ""
    continue_on_error: true

  - name: Repository Cleanup Check
    run: |
      echo "ğŸ§¹ Checking for issues..."
      npm run repo:clean > /tmp/repo-clean-output.txt 2>&1
      
      if grep -q "âŒ HIGH PRIORITY" /tmp/repo-clean-output.txt; then
        echo "âŒ ERROR: High priority issues found"
        cat /tmp/repo-clean-output.txt
        echo ""
        echo "Fix with: npm run repo:clean --fix"
        exit 1
      else
        echo "âœ… No high priority issues"
      fi
      echo ""

  - name: Type Check
    run: |
      echo "ğŸ”· Type checking..."
      npx tsc --noEmit
      echo ""
    continue_on_error: true

  - name: Lint Check
    run: |
      echo "âœ¨ Linting..."
      npm run lint
      echo ""
    continue_on_error: true

  - name: Security Tests
    run: |
      echo "ğŸ”’ Running security tests..."
      npm run test:security
      echo ""

  - name: Check Database Changes
    run: |
      if git diff --cached --name-only | grep -q "supabase/migrations"; then
        echo "ğŸ—„ï¸  Database changes detected, validating..."
        npm run db:validate
        echo ""
      else
        echo "No database changes detected"
        echo ""
      fi
    continue_on_error: true

  - name: Run Tests
    run: |
      echo "ğŸ§ª Running tests..."
      npm test -- --passWithNoTests
      echo ""
    continue_on_error: true

  - name: Summary
    run: |
      echo ""
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "âœ… All pre-commit checks passed!"
      echo ""
      echo "Your code is ready to commit. ğŸš€"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
